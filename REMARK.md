## 数据分片思想：
### 1 数据分片分为两种：水平分片和垂直分片。
#### 1.1 水平分片 ####
- 库内分表

        在同一个数据库中，将一张表中的记录即通过某种规则分散到多个表中，每张表中只包含一部分数据，从而使单张表的数据量变小。
      库内分表只解决单一表数据量过大的问题，但没有将表分布到不同机器的库上，因些对于减轻mysql的压力来说帮助不是很大，大家还是竞争同一个物理机的CPU、内存、网络IO，最好通过分库分表来解决。
- 分库分表

    是根据表内数据内在的逻辑关系，将同一个表按不同的条件分散到多个数据库

- 水平切分优点

    - 不存在单库数据量过大、高并发的性能瓶颈，提升系统稳定性和负载能力。
    - 应用端改造较小，不需要拆分业务模块。
    
- 水平切分缺点

    - 跨分片的事务一致性难以保证
    - 跨库的join关联查询性能较差
    - 数据多次扩展维度和维护量极大。
    
##### 1.1.1 路由规则

###### a. 范围路由 

- 介绍

          选取有序的数据列，如时间戳作为路由的条件，不同分段分散到不同的数据库表中，以最常见的用户ID为例，路由算法可以按照1000000的范围大小进行分段，1 ~ 9999999放到数据库1的表中，10000000~199999999放到数据库2的表中，以此累推。
      范围路由设计的复杂点主要体现在分段大小的选取上，分段太小会导致切分后子表数量过多增加维护复杂度，分段太大可能会导致单表依然存在性能问题，按一般大老们的经验，分段大小100W至2000W之间，具体需要根据业务选 取合适的分段大小。

- 范围路由优点

    - 可以随着数据的增加平滑地扩充新的表或库，原有的数据不需要动。
    - 单表大小可控
    - 使用分片字段进行范围查找时，连续分片可快速定位查询，有效避免分片查询的问题。
 
- 范围路由缺点
    - 热点数据成为性能瓶颈，连续分片可能存在数据热点，例如按时单字段分片，有些分片存储最近时间内的数据，可能会被频繁读写，而有些历史数据则很少被查询。
    
###### b.hash算法

- 介绍

          选取某个列或几个列的值进行hash运算，然后根据hash的结果分散到不同的数据库表中，以用ID为例，假如我们一开始就规划10个数据库表，路由算法可以简单地用id % 10的值来表示数据所属的数据库编号，ID为985的用户放到编号为5的子表中。ID为10086编号放到编号为6的表中。
        Hash路由设计的复杂点主要体现 在初始表数量的选取上，表数量太多维护比较麻烦，表数量太小又可能导致单表性能存在问题。而用Hash路由后，增加字表数量是非常麻烦的，所有数据都要重新分布。

- hash算法优缺点

    Hash路由的优缺点与范围路由相反，Hash路由的优点是表分布比较均匀，缺点是扩容时很麻烦，所有数据均需要重新分布。


###### c.路由配置

- 介绍

  配置路由就是路由表，用一张独立的表来记录路由信息。同样以用户ID为例，我们新增一张ROUTER表，这个表包含table_Id两列，根据user_id就可以查询对应的修改路由表就可以了。
配置路由设计简单，使用起来非常灵活，尤其是在扩充表的时候，只需要迁移指定的数据，然后修改路由表就可以了。

- 缺点

    必须多查询一次，会影响整体性能，而且路由表本身如果太大，性能会成为瓶颈点，如果我们再将路由表分库分表，则又面临一个死循环。

##### d.分库分表带来的问题

- join操作

    水平分表后，虽然物理上分散在多个表中，如果需要与其它表进行join查询，需要在业务代码或者数据库中间件中进行多次join查询，然后将结果合并。
    
- COUNT(*)操作

    水平分表后，某些场景下需要将这些表当作一个表来处理。

- order by操作

    分表后，数据分散到多个表中，排序操作无法在数据库中完成，只能由业务代码或数据中间件分别查询每个子表中的数据，然后汇总进行排序。
    
#### 1.2 垂直分片 （纵向切分）
- 垂直分库

    （简单点理解就是：将不同的业务表放到不同的数据库中）垂直分库是根据业务的耦合性，将关联度低的表储存在不同的数据库。类似于微服务治理的做法，不同的微服务使用单独的数据库。
    
- 垂直分表

    （简单点理解就是：如果一个数据表中的字段过多，分出来几个）垂直分表是基于数据库中的列进行的，某个表的字段比较多，可以新建一张扩展表，将一些不经常用的字段或者字段长度较大的字段拆出
    到扩展表中。
    
- 垂直切分优点

    - 解决业务系统层面的耦合，业务清晰
    - 与微服务的治理类似，也能对不同业务的数据进行分级管理，维护，监控，扩展等。
    - 高并发场景下，垂直切分一定程度的提升IO，数据库连接数，单机硬件资源的瓶颈。
    
- 垂直切分缺点

    - 部分表无法join，只能通过接口聚合方式解决，提升了开发的复杂度。
    - 分布式事处理复杂
    - 依然存在单表数据量过大的问题。
    
